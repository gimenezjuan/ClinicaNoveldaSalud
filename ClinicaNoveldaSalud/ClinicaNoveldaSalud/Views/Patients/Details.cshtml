@model ClinicaNoveldaSalud.Models.Patient
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "Ficha de Paciente";
    var duplicates = ViewData["DuplicatePatients"]
                    as IEnumerable<dynamic>;
    var fromDate = ViewData["FromDate"] as DateTime?;
    var onlyWithFiles = ViewData["OnlyWithFiles"] as bool?;
    var visitDateOptions = ViewData["VisitDateOptions"] as SelectList;
}


<h1>@Model.FullName</h1>
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorMessage"]
    </div>
}
@if (TempData["FormError"] != null)
{
    <div class="alert alert-danger">
        @TempData["FormError"]
    </div>
}
<div class="mb-4">
    <dl class="row">
        <dt class="col-sm-3">Fecha de nacimiento</dt>
        <dd class="col-sm-9">@Model.BirthDate?.ToString("dd/MM/yyyy")</dd>

        <dt class="col-sm-3">Teléfono</dt>
        <dd class="col-sm-9">@Model.Phone</dd>

        <dt class="col-sm-3">Aseguradora</dt>
        <dd class="col-sm-9">@Model.InsurerName</dd>
    </dl>
    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-primary">
        Editar Paciente
    </a>
    <a asp-action="Index" class="btn btn-secondary">Volver al listado</a>
</div>

<h3>Añadir nueva visita</h3>
<div id="addVisitContainer">
    @await Html.PartialAsync(
    "_AddVisitPartial",
        new ClinicaNoveldaSalud.Models.ViewModels.AddVisitViewModel
        {
            PatientId = Model.Id,
            VisitDate = DateTime.Today
        })
</div>
<br />
<br />
@if (duplicates != null && duplicates.Any())
{
    <div class="alert alert-info">
        <strong>Otras fichas de este paciente:</strong>
        <ul class="mb-0">
            @foreach (var d in duplicates)
            {
                <li>
                    <a asp-action="Details"
                       asp-route-id="@d.Id">
                        Ver en “@d.DeptName”
                    </a>
                </li>
            }
        </ul>
    </div>
}

<hr />
<form method="get" class="row g-2 mb-3">
    <input type="hidden" name="id" value="@Model.Id" />

    <div class="col-auto">
        <label class="form-label">Filtrar por fecha:</label>
        <select name="fromDate" class="form-select" asp-items="visitDateOptions">
            <option value="">Todas las fechas</option>
        </select>
    </div>

    <div class="col-auto">
        <label class="form-label">Solo con archivos:</label>
        <input type="checkbox" name="onlyWithFiles" value="true"
               @(onlyWithFiles == true ? "checked" : "") />
    </div>

    <div class="col-auto align-self-end">
        <button type="submit" class="btn btn-outline-primary">Filtrar visitas</button>
        <a asp-action="Details"
           asp-route-id="@Model.Id"
           class="btn btn-link">Limpiar</a>
    </div>
</form>

@foreach (var pd in Model.PatientDepartments
                      .OrderByDescending(pd => pd.CreatedAt))
{
    <div class="card mb-3">
        <div class="card-header">
            Departamento: @pd.DepartmentName
            <span class="badge bg-light text-dark float-end">
                Creado @pd.CreatedAt.ToString("dd/MM/yyyy")
            </span>
        </div>
        <div class="card-body p-0">
            <table class="table mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Fecha visita</th>
                        <th>Comentarios</th>
                        <th>Adjuntos</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var v in pd.Visits.OrderByDescending(v => v.VisitDate)
                                                .Where(v =>
                                                (!fromDate.HasValue || v.VisitDate.Date == fromDate.Value.Date) &&
                                                (!onlyWithFiles.HasValue || !onlyWithFiles.Value || v.Attachments.Any())))
                    {
                        <tr>
                            <td>@v.VisitDate.ToString("dd/MM/yyyy")</td>
                            <td style="white-space: pre-wrap; word-wrap: break-word; max-width:300px;">
                                @v.Comments
                            </td>
                            <td>
                                @foreach (var a in v.Attachments)
                                {
                                    <div class="d-flex align-items-center">
                                        <a target="_blank"
                                           href="~/uploads/@Model.Id/@v.Id/@a.FileName">
                                            @a.FileName
                                        </a>
                                        <form asp-controller="VisitAttachments"
                                              asp-action="Delete"
                                              method="post"
                                              class="ms-2">
                                            <input type="hidden" name="id" value="@a.Id" />
                                            <button type="submit"
                                                    class="btn btn-sm btn-outline-danger">
                                                🗑
                                            </button>
                                        </form>
                                    </div>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
